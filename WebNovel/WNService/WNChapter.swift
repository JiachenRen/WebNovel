//
//  WNChapter.swift
//  WebNovel
//
//  Created by Jiachen Ren on 6/15/19.
//  Copyright Â© 2019 Jiachen Ren. All rights reserved.
//

import Foundation

class WNChapter: Serializable, CustomStringConvertible {
    typealias ManagedObject = Chapter
    
    /// Reference to the web novel that this chapter belongs to
    var webNovelUrl: String
    
    // Basic info
    var url: String
    var chapter: String
    
    // Raw html content of the chapter
    var rawHtml: String?
    
    // Sanitized chapter infomation generated by a host-specific parser
    var date: String?
    var title: String?
    var textContent: String?

    // Article contains relevant reader's info generated by a
    // non-host-specific, generic parser, namely Readability.js
    var article: Article?
    
    /// Id of the chapter
    var id: Int
    
    init(_ webNovelUrl: String, url: String, chapter: String, id: Int) {
        self.webNovelUrl = webNovelUrl
        self.url = url
        self.chapter = chapter
        self.id = id
    }
    
    /// Extracts chapter number and title from raw title string
    private func parseChapterTitle() -> (chapter: Int, title: String)? {
        guard let rawTitleStr = title ?? article?.title else {
            return nil
        }
        var chapter: Int?, title: String?
        let pattern = #"[cC]hapter\s*([0-9]+)[\:\-\s]+(.*)"#
        let regex = try! NSRegularExpression(pattern: pattern, options: [])
        let range = NSRange(location: 0, length: rawTitleStr.utf16.count)
        if let match = regex.firstMatch(in: rawTitleStr, options: [], range: range) {
            if let chapterRange = Range(match.range(at: 1), in: rawTitleStr) {
                chapter = Int(rawTitleStr[chapterRange])
            }
            if let titleRange = Range(match.range(at: 2), in: rawTitleStr) {
                title = String(rawTitleStr[titleRange])
            }
        }
        guard let ch = chapter, let t = title else {
            return nil
        }
        return (ch, t)
    }
    
    /// - Returns: Properly formatted chapter title in the following format:
    /// Chapter <#>: <Name>
    func properTitle() -> String? {
        guard let (ch, t) = parseChapterTitle() else {
            return nil
        }
        return "Chapter \(ch): \(t)"
    }

    
    var description: String {
        return """
        Web Novel Link: \(webNovelUrl)
        ID: \(id)
        Chapter: \(chapter)
        Link: \(url)
        Title: \(title.losslessStr)
        Date: \(date.losslessStr)
        Text Content: \(textContent.losslessStr)
        """
    }
}
